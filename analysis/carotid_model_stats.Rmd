---
title: "Figures ICAI Sim"
author: "Guillaume Kugener"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include=FALSE)
library(tidyverse)
library(ggrepel)
library(magrittr)
library(reshape2)
library(ggpubr)
library(ggsci)
library(data.table)
```

```{r include=FALSE}
plot_dir <- '~/Documents/USC/USC_docs/ml/surgical-training-project/data/carotid_outcomes/'
file_to_use <- '~/Documents/USC/USC_docs/ml/surgical-training-project/data/UPDATED_Raw Data.xlsx - Sheet1.tsv'

raw_data <- read_tsv(file_to_use) %>% 
  filter(!is.na(SurveyID)) %>%
  mutate(Group=case_when(
    (!is.na(Attyears) & Attyears) >= 1 ~ 'Attending',
    (!is.na(Resyears) & Resyears) >= 1 ~ 'Resident',
    TRUE ~ 'None'
  )) %>%
  # For now, filter out those that are not attendings or residents, but will want to come back to this later
  filter(Group != 'None')

# We should remove the people who did three trials for now, as they were not trained between trial 1 and 2 but trained between trials 2 and 3, so we will need to think about how to compare them to everyone else
raw_data %<>% filter(is.na(`Trial 3 Start Time (hhmmss)`))
```

<!-- ## Trial success -->

```{r}
success_rate_overall <- raw_data %>% 
  dplyr::select(SurveyID, `Trial 1` = `Trial 1 Success`, `Trial 2`=`Trial 2 Success`) %>%
  gather(trial, s, -SurveyID) %>%
  filter(!is.na(s)) %>%
  group_by(trial) %>%
  dplyr::summarise( 
    rate=length(which(s==1))/n()
  )

# Contigency table creation
fisher_success_overall <- raw_data %>% 
  dplyr::select(SurveyID, `Trial 1`=`Trial 1 Success`, `Trial 2`=`Trial 2 Success`) %>%
  gather(trial, s, -SurveyID) %>%
  filter(!is.na(s)) %>%
  group_by(trial, s) %>%
  dplyr::summarise(count=n()) %>%
  mutate(v=ifelse(s==0, 'fail', 'success')) %>%
  dcast(trial ~ v, value.var='count') %>%
  column_to_rownames('trial') %>%
  fisher.test()

success_rate_by_group <- raw_data %>% 
  dplyr::select(SurveyID, Group, `Trial 1`=`Trial 1 Success`, `Trial 2`=`Trial 2 Success`) %>%
  gather(trial, s, -SurveyID, -Group) %>%
  filter(!is.na(s)) %>%
  group_by(Group, trial) %>%
  dplyr::summarise( 
    rate=length(which(s==1))/n()
  )

prep_fisher_success_by_group <- raw_data %>% 
  dplyr::select(SurveyID, Group, `Trial 1`=`Trial 1 Success`, `Trial 2`=`Trial 2 Success`) %>%
  gather(trial, s, -SurveyID, -Group) %>%
  filter(!is.na(s)) %>%
  group_by(Group, trial, s) %>%
  dplyr::summarise(count=n()) %>%
  mutate(v=ifelse(s==0, 'fail', 'success')) %>%
  dcast(Group + trial ~ v, value.var='count')

fisher_attendings_success_rate <- prep_fisher_success_by_group %>%
  filter(Group=='Attending') %>%
  dplyr::select(-Group) %>%
  column_to_rownames('trial') %>%
  fisher.test()

fisher_residents_success_rate <- prep_fisher_success_by_group %>%
  filter(Group=='Resident') %>%
  dplyr::select(-Group) %>%
  column_to_rownames('trial') %>%
  fisher.test()
```

```{r}
overall_success_rate <- ggplot(success_rate_overall, aes(trial, rate)) +
  geom_bar(stat = 'identity', color='black', fill='grey', alpha = 0.5) +
  # scale_fill_jama() +
  # facet_wrap(~Group) +
  xlab('Trial Number') +
  ylab('Trial success rate') +
  scale_y_continuous(limits = c(0, 1.05), expand = c(0,0)) +
  theme_bw() +
  theme(
    text = element_text(size = 12),
    axis.text = element_text(size=12),
    # axis.title = element_text(size=12),
    axis.title.x = element_blank(),
    panel.grid.major.x = element_blank(),
    legend.position = 'none',
    strip.text = element_text(size = 12)
  )
```

```{r}
by_group_success_rate <- ggplot(success_rate_by_group, aes(Group, rate, fill=trial)) +
  geom_bar(stat = 'identity', color='black', position = position_dodge()) +
  scale_fill_brewer() +
  guides(fill=guide_legend(title = '', title.position = 'bottom')) +
  # facet_wrap(~Group) +
  xlab('Trial Number') +
  ylab('Trial success rate') +
  # facet_wrap(~Group) +
  scale_y_continuous(limits = c(0, 1.05), expand = c(0,0)) +
  theme_bw() +
  theme(
    text = element_text(size = 12),
    axis.text = element_text(size=12),
    # axis.title = element_text(size=12),
    axis.title.x = element_blank(),
    panel.grid.major.x = element_blank(),
    legend.position = c(0.01,0.99),
    legend.justification = c(0,1),
    legend.background = element_rect(fill='transparent'),
    legend.text = element_text(size=12),
    strip.text = element_text(size = 12)
  )
```

<!-- ## Changes in Heart Rate -->

<!-- The plot below compares the average and peak heart rates at different points in the trials. -->

```{r include=FALSE}
heart_rate_columns <- raw_data %>% colnames() %>% .[grep('Peak|Average', .)]
heart_rate_data <- raw_data %>%
  dplyr::select(SurveyID, Group, heart_rate_columns) %>%
  gather(var, value, -SurveyID, -Group) %>%
  mutate(
    timing=stringr::str_extract(pattern='Base?line|Trial [12]|Intertrial|Posttrial', var),
    value_type = stringr::str_extract(pattern='Peak|Average', var)
  ) %>%
  mutate(timing=gsub('Basline', 'Baseline', timing)) %>%
  mutate(timing=factor(timing, c('Baseline', 'Trial 1', 'Intertrial', 'Trial 2', 'Posttrial')))

# To look for those that have complete data
counts_by_individual <- heart_rate_data %>%
  filter(value_type=='Peak') %>%
  group_by(SurveyID) %>%
  dplyr::summarise(count=length(which(!is.na(value)))) %>%
  arrange(-count)
```

<!-- A plot of the heart rate data, with t-tests done comparing each group to the baseline HR -->

```{r}
ggplot(heart_rate_data, aes(timing, value)) +
  geom_boxplot(outlier.shape = NA) +
  # geom_point(position = position_jitter(width = 0.25)) +
  stat_compare_means(method = "anova", label.y = 180) +
  stat_compare_means(label = "p.signif", method = "t.test",
                     ref.group = "Baseline", label.y = 170) +  
  xlab('Training status') +
  ylab('Heart rate') +
  facet_wrap(Group~value_type, ncol = 2)
```

```{r}
# To present it as a bar plot instead
ggbarplot(heart_rate_data %>% filter(!is.na(value), value_type=='Average'), x="timing", y="value", add="mean_se") +
  # geom_bar(stat = 'identity') +
  stat_compare_means() +
  stat_compare_means(label = "p.signif", method = "t.test",
                     ref.group = "Baseline", label.y = 120) +  
  xlab('Training status') +
  ylab('Heart rate') +
  facet_wrap(~value_type, ncol = 1)
```

<!-- ## Time to hemostasis -->

<!-- A look at the time to hemostasis  -->

```{r include=FALSE}
tth_columns <- raw_data %>% colnames() %>% .[grep('TTH', .)] %>% setdiff(., c('Trial 1 TTH_1', 'Trial 2 TTH_1'))
tth_data <- raw_data %>%
  dplyr::select(SurveyID, Group, tth_columns) %>%
  gather(var, value, -SurveyID, -Group) %>%
  mutate(trial = gsub(' TTH', '', var)) %>%
  mutate(trial=factor(trial, c('Trial 1', 'Trial 2', 'Trial 3')))

# To look for those that have complete data
counts_by_individual <- tth_data %>%
  group_by(SurveyID) %>%
  dplyr::summarise(count=length(which(!is.na(value)))) %>%
  arrange(-count)

tth_data %>%
  group_by(trial, Group) %>%
  dplyr::summarise(m=mean(value, na.rm = T))
```

```{r}
tth_bar_plot_data <- tth_data %>% 
  filter(trial != 'Trial 3') %>% 
  mutate(Group='All') %>%
  group_by(trial) %>%
  dplyr::summarise(m=mean(value, na.rm = T), s=sd(value, na.rm = T)/sqrt(length(value[!is.na(value)])))
```

```{r}
tth_overall_plot <- ggpubr::ggbarplot(
  data = tth_data %>%
    filter(trial != 'Trial 3', !is.na(value)) %>%
    mutate(Group='All'),
  add = c("mean_se"),
  x = 'trial', y = 'value', fill = 'trial'
) +
stat_compare_means(label = "p.format", method = "t.test",
ref.group = "Trial 1", label.y = 300, paired = T) +
  scale_fill_jama() +
  # facet_wrap(~Group) +
  xlab('Trial Number') +
  ylab('Time to Hemostasis') +
  scale_y_continuous(expand = c(0,0), limits = c(0, 320)) +
  theme_bw() +
  theme(
    text = element_text(size = 12),
    axis.text = element_text(size=12),
    # axis.title = element_text(size=12),
    axis.title.x = element_blank(),
    panel.grid.major.x = element_blank(),
    legend.position = 'none',
    strip.text = element_text(size = 12)
  )

tth_overall_plot <- ggplot(tth_bar_plot_data, aes(trial, m)) +
  geom_bar(stat='identity', color='black', fill='grey', alpha = 0.5) +
  geom_errorbar(aes(ymin=m-s, ymax=m+s), width=0.2) +
  annotate(x = 2, y = 280,geom = 'text', label = '*', size = 12) +
  # geom_point(position = position_jitter(width = 0.25)) +
  scale_fill_jama() +
  # facet_wrap(~Group) +
  xlab('Trial Number') +
  ylab('Time to Hemostasis') +
  scale_y_continuous(expand = c(0,0), limits = c(0, 310)) +
  theme_bw() +
  theme(
    text = element_text(size = 12),
    axis.text = element_text(size=12),
    # axis.title = element_text(size=12),
    axis.title.x = element_blank(),
    panel.grid.major.x = element_blank(),
    legend.position = 'none',
    strip.text = element_text(size = 12)
  )
```

```{r}
tth_bar_plot_data_group <- tth_data %>% 
  filter(trial != 'Trial 3') %>% 
  group_by(trial, Group) %>%
  dplyr::summarise(m=mean(value, na.rm = T), s=sd(value, na.rm = T)/sqrt(length(value[!is.na(value)])))

tth_split_by_training <- ggplot(tth_bar_plot_data_group, aes(Group, m, fill=trial)) +
  geom_bar(stat='identity', color='black', position = position_dodge()) +
  geom_errorbar(aes(ymin=m-s, ymax=m+s), width=0.2, position = position_dodge(width = 0.9)) +
  guides(fill=guide_legend(title='', title.position = 'bottom')) +
  # annotate(x = 2, y = 280,geom = 'text', label = '*', size = 12) +
  # geom_point(position = position_jitter(width = 0.25)) +
  scale_fill_brewer() +
  xlab('Trial Number') +
  ylab('Time to Hemostasis') +
  # facet_wrap(~Group) +
  scale_y_continuous(expand = c(0,0), limits = c(0, 310)) +
  theme_bw() +
  theme(
    text = element_text(size = 12),
    axis.text = element_text(size=12),
    # axis.title = element_text(size=12),
    axis.title.x = element_blank(),
    panel.grid.major.x = element_blank(),
    legend.position = 'none',
    # legend.position = c(0.01, 0.99),
    # legend.justification = c(0,1),
    # legend.background = element_rect(fill='transparent'),
    # legend.text = element_text(size=12),
    strip.text = element_text(size = 12)
  )

tth_split_by_training
```

```{r}
ggpaired(tth_data %>% filter(!is.na(value)), x='var', y='value', line.color = 'grey', line.size = 0.4) +
  facet_wrap(~Group)
```


```{r}
tth_data_m_median <- tth_data %>%
  # filter(Group == 'Attending') %>%
  filter(!is.na(value), trial %in% c('Trial 1', 'Trial 2')) %>%
  group_by(trial) %>%
  dplyr::summarise(m = mean(value), med=median(value))

tth_data_t_test <- tth_data %>%
  # filter(Group == 'Attending') %>%
  filter(!is.na(value), trial %in% c('Trial 1', 'Trial 2')) %>%
  dcast(SurveyID + Group ~ var, value.var = 'value') %$%
  t.test(x = `Trial 1 TTH`, y = `Trial 2 TTH`, paired = T)

tth_data_t_test_by_group <- tth_data %>%
  # filter(Group == 'Attending') %>%
  filter(!is.na(value), trial %in% c('Trial 1', 'Trial 2')) %>%
  dcast(SurveyID + Group ~ var, value.var = 'value') %>%
  group_by(Group) %>%
  dplyr::summarise(
    m_t1 = mean(`Trial 1 TTH`),
    m_t2 = mean(`Trial 2 TTH`),
    p = t.test(x = `Trial 1 TTH`, y = `Trial 2 TTH`, paired = T)$p.value,
    ci_low = t.test(x = `Trial 1 TTH`, y = `Trial 2 TTH`, paired = T)$conf.int[1],
    ci_high = t.test(x = `Trial 1 TTH`, y = `Trial 2 TTH`, paired = T)$conf.int[2]
  )
```

<!-- ## Estimated blood loss -->

<!-- A look at the estimated blood loss -->

```{r include=FALSE}
ebl_columns <- raw_data %>% colnames() %>% .[grep('ebl', .)]
ebl_data <- raw_data %>%
  dplyr::select(SurveyID, Group, ebl_columns) %>%
  magrittr::set_colnames(gsub('  ', ' ', colnames(.))) %>%
  gather(var, value, -SurveyID, -Group) %>%
  mutate(trial = gsub(' ebl', '', var)) %>%
  mutate(trial=factor(gsub('^t', 'T', trial), c('Trial 1', 'Trial 2', 'Trial 3')))

# To look for those that have complete data
ebl_counts_by_individual <- ebl_data %>%
  group_by(SurveyID) %>%
  dplyr::summarise(count=length(which(!is.na(value)))) %>%
  arrange(-count)
```

```{r}
# Remove the one case that is not paired
ebl_all_paired <- ebl_data %>% 
  filter(trial != 'Trial 3', !is.na(value)) %>%
  group_by(SurveyID) %>%
  dplyr::summarise(count=n()) %>% 
  filter(count == 2) %$% SurveyID
```

```{r}
overall_ebl_data <- ebl_data %>% 
  filter(trial != 'Trial 3', SurveyID %in% ebl_all_paired) %>%
  group_by(trial) %>%
  dplyr::summarise(m=mean(value, na.rm=T), s = sd(value)/sqrt(length(value[!is.na(value)])))

overall_ebl <- ggplot(overall_ebl_data, aes(trial, m)) +
  geom_bar(stat='identity', color='black', fill='grey', alpha = 0.5) +
  geom_errorbar(aes(ymin=m-s, ymax=m+s), width=0.2) +
  annotate(x = 2, y = 600,geom = 'text', label = '*', size = 12) +
  # geom_point(position = position_jitter(width = 0.25)) +
  xlab('Trial Number') +
  ylab('Estimated Blood Loss (mL)') +
  scale_y_continuous(expand=c(0,0), limits = c(0, 650)) +
  # facet_wrap(~Group) +
  theme_bw() +
  theme(
    text = element_text(size = 12),
    axis.text = element_text(size=12),
    # axis.title = element_text(size=12),
    axis.title.x = element_blank(),
    panel.grid.major.x = element_blank(),
    legend.position = 'none',
    strip.text = element_text(size = 12)
  )

overall_ebl
```

```{r}
by_group_ebl_data <- ebl_data %>% 
  filter(trial != 'Trial 3', SurveyID %in% ebl_all_paired) %>%
  group_by(Group, trial) %>%
  dplyr::summarise(m=mean(value, na.rm=T), s = sd(value)/sqrt(length(value[!is.na(value)])))

by_group_ebl <- ggplot(by_group_ebl_data, aes(Group, m, fill=trial)) +
  geom_bar(stat='identity', color='black', position = position_dodge()) +
  geom_errorbar(aes(ymin=m-s, ymax=m+s), width=0.2, position = position_dodge(width=0.9)) +
  # annotate(x = 2, y = 750,geom = 'text', label = '*', size = 12) +
  guides(fill=guide_legend(title='', title.position = 'bottom')) +
  # geom_point(position = position_jitter(width = 0.25)) +
  scale_fill_brewer() +
  xlab('Trial Number') +
  ylab('Estimated Blood Loss (mL)') +
  scale_y_continuous(expand=c(0,0), limits = c(0, 800)) +
  theme_bw() +
  theme(
    text = element_text(size = 12),
    axis.text = element_text(size=12),
    # axis.title = element_text(size=12),
    axis.title.x = element_blank(),
    panel.grid.major.x = element_blank(),
    legend.position= 'none',
    # legend.position = c(0.01,0.99),
    # legend.justification = c(0,1),
    # legend.background = element_rect(fill='transparent'),
    # legend.text = element_text(size=12),
    strip.text = element_text(size = 12)
  )

by_group_ebl
```

```{r}
ebl_test_test_values <- ebl_data %>%
  filter(SurveyID %in% ebl_all_paired) %>%
  # filter(Group == '') %>%
  filter(!is.na(value), trial %in% c('Trial 1', 'Trial 2')) %>%
  dcast(SurveyID + Group ~ var, value.var = 'value') %$%
  t.test(x = `trial 1 ebl`, y = `trial 2 ebl`, paired = T)

ebl_test_test_values_by_group <- ebl_data %>%
  filter(SurveyID %in% ebl_all_paired) %>%
  # filter(Group == '') %>%
  filter(!is.na(value), trial %in% c('Trial 1', 'Trial 2')) %>%
  dcast(SurveyID + Group ~ var, value.var = 'value') %>%
  group_by(Group) %>%
  dplyr::summarise(
    p=t.test(x = `trial 1 ebl`, y = `trial 2 ebl`, paired = T)$p.value,
    ci_low=t.test(x = `trial 1 ebl`, y = `trial 2 ebl`, paired = T)$conf.int[1],
    ci_high=t.test(x = `trial 1 ebl`, y = `trial 2 ebl`, paired = T)$conf.int[2]
  )
```

<!-- ## EBL vs. TTH colored by trial -->

```{r}
scatter_ebl_tth <- raw_data %>% 
  dplyr::select(SurveyID, Group, `Trial 1 TTH`, `Trial 2 TTH`, `trial 1 ebl`, `trial 2  ebl`) %>%
  gather(var, value, -SurveyID, -Group) %>%
  mutate(variable = gsub('.* ', '', var)) %>%
  mutate(trial = stringr::str_extract(string=var, pattern='[0-9]+')) %>%
  dcast(SurveyID + Group + trial ~ variable, value.var='value')

change_in_scores <- scatter_ebl_tth %>% 
  setDT() %>% 
  dcast(SurveyID + Group ~ trial, value.var=c('ebl', 'TTH')) %>%
  mutate(change_in_tth=TTH_1 - TTH_2, change_in_ebl = ebl_1 - ebl_2)

ordered_survey_id <- change_in_scores %>%
  arrange(change_in_tth) %$%
  SurveyID

change_in_scores %<>% mutate(SurveyID = factor(SurveyID, levels=ordered_survey_id))
```

```{r}
# Maybe highlight (with grey in the background) for the ones that improved (right lower quadrant, highlight in red for example)
tth_change_overall <- ggplot(change_in_scores, aes(SurveyID, change_in_tth, color=Group)) +
  geom_segment(aes(x = SurveyID, xend=SurveyID, y = 0, yend = change_in_tth)) +
  geom_point() +
  guides(color=guide_legend(title = NA, title.position = 'bottom')) +
  scale_color_jama() +
  xlab('Individual ranked by improvement based on TTH change') +
  ylab('TTH seconds saved (Trial 1 vs. Trial 2)') +
  theme_bw() +
  theme(
    legend.position = c(0.01,0.99),
    legend.justification = c(0,1),
    legend.background = element_rect(fill='transparent'),
    legend.text = element_text(size=12),
    legend.title = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank()
  )
```

```{r}
# Maybe highlight (with grey in the background) for the ones that improved (right lower quadrant, highlight in red for example)
ebl_change_overall <- ggplot(change_in_scores, aes(SurveyID, change_in_ebl, color=Group)) +
  geom_segment(aes(x = SurveyID, xend=SurveyID, y = 0, yend = change_in_ebl)) +
  geom_point() +
  guides(color=guide_legend(title = NA, title.position = 'bottom')) +
  scale_color_jama() +
  xlab('Individual ranked by improvement based on TTH change') +
  ylab('EBL (mL) saved (Trial 1 vs. Trial 2)') +
  theme_bw() +
  theme(
    legend.position = 'none',
    # legend.position = c(0.01,0.99),
    # legend.justification = c(0,1),
    # legend.background = element_rect(fill='transparent'),
    # legend.text = element_text(size=12),
    legend.title = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank()
  )
```

```{r}
ggplot(change_in_scores, aes(color=Group)) +
  geom_segment(aes(x = SurveyID, xend=SurveyID, y = TTH_1, yend = TTH_2)) +
  geom_point(aes(x=SurveyID, y= TTH_1), color = 'blue') +
  geom_point(aes(x=SurveyID, y= TTH_2), color='red') +
  xlab('Individual ranked by improvement based on TTH change') +
  ylab('TTH seconds saved (Trial 1 vs. Trial 2)') +
  theme_bw() +
  theme(
    # legend.position = c(0.01,0.99),
    # legend.justification = c(0,1),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )
```

```{r}
ggplot(change_in_scores, aes(color=Group)) +
  geom_segment(aes(x = SurveyID, xend=SurveyID, y = TTH_1, yend = TTH_2)) +
  geom_point(aes(x=SurveyID, y= TTH_1), color = 'blue') +
  geom_point(aes(x=SurveyID, y= TTH_2), color='red') +
  xlab('Individual ranked by improvement based on TTH change') +
  ylab('TTH seconds saved (Trial 1 vs. Trial 2)') +
  theme_bw() +
  theme(
    # legend.position = c(0.01,0.99),
    # legend.justification = c(0,1),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )
```

```{r}
ggplot(scatter_ebl_tth %>% mutate(SurveyID = factor(SurveyID, levels = ordered_survey_id)), aes(SurveyID, TTH, fill = trial)) +
  geom_bar(stat = 'identity', position = position_dodge()) +
  # geom_bar(stat='identity', alpha = 0.5) +
  ylab('EBL mL saved (Trial 1 vs. Trial 2)') +
  theme_bw() +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )
```

```{r}
scatter_plot_attempt <- ggplot(scatter_ebl_tth, aes(TTH, ebl, color=trial)) +
  geom_point() +
  # geom_segment(data=change_in_scores, 
    # aes(x = TTH_1, xend=TTH_2, y = ebl_1, yend = ebl_2), color='grey', alpha = 0.5) +
  # geom_smooth(method = 'lm') +
  # geom_density2d() +
  scale_x_log10() +
  scale_y_log10() +
  # facet_wrap(~Group) +
  theme_bw()

ggsave(scatter_plot_attempt, filename = file.path(plot_dir, 'scatter_plot.pdf'), width = 5, height = 5, device='pdf')
```

<!-- ## Most improved -->

```{r include=FALSE}
most_improved_data <- raw_data %>%
  dplyr::select(SurveyID, Group, tth_columns, `Trial 1 Success`, `Trial 2 Success`) %>%
  gather(var, value, -SurveyID, -Group, -`Trial 1 Success`, -`Trial 2 Success`) %>%
  mutate(trial = gsub(' TTH', '', var)) %>%
  mutate(trial=factor(trial, c('Trial 1', 'Trial 2', 'Trial 3'))) %>%
  filter(`Trial 1 Success` == 0, `Trial 2 Success` == 1) %>%
  dplyr::rename(tth=value) %>%
  left_join(., 
    raw_data %>%
      dplyr::select(SurveyID, Group, `Trial 1 Success`, `Trial 2 Success`, ebl_columns) %>%
      magrittr::set_colnames(gsub('  ', ' ', colnames(.))) %>%
      gather(var, value, -SurveyID, -Group, -`Trial 1 Success`, -`Trial 2 Success`) %>%
      mutate(trial = gsub(' ebl', '', var)) %>%
      mutate(trial=factor(gsub('^t', 'T', trial), c('Trial 1', 'Trial 2', 'Trial 3'))) %>%
      filter(`Trial 1 Success` == 0, `Trial 2 Success` == 1) %>%
      dplyr::select(SurveyID, trial, ebl=value),
    by = c('SurveyID', 'trial')
  )

types_most_improved <- most_improved_data %>%
  group_by(Group) %>%
  dplyr::summarise(count=n())

most_improved_data_bar_plot_data <- most_improved_data %>% 
  filter(trial != 'Trial 3') %>% 
  group_by(trial) %>%
  dplyr::summarise(
    tth_m=mean(tth, na.rm = T), 
    tth_sd=sd(tth, na.rm = T)/sqrt(length(tth[!is.na(tth)])),
    ebl_m=mean(ebl, na.rm = T), 
    ebl_sd=sd(ebl, na.rm = T)/sqrt(length(ebl[!is.na(ebl)]))
  )
```

```{r}
most_improved_tth <- ggplot(most_improved_data_bar_plot_data, aes(trial, tth_m)) +
  geom_bar(stat='identity', color='black', fill='grey', alpha = 0.5) +
  geom_errorbar(data=most_improved_data_bar_plot_data %>% filter(trial == 'Trial 2'), aes(ymin=tth_m-tth_sd, ymax=tth_m+tth_sd), width=0.2) +
  # geom_point(position = position_jitter(width = 0.25)) +
  scale_fill_jama() +
  # facet_wrap(~Group) +
  xlab('Trial Number') +
  ylab('Time to Hemostasis (sec)') +
  scale_y_continuous(expand = c(0,0), limits = c(0, 310)) +
  theme_bw() +
  theme(
    text = element_text(size = 12),
    axis.text = element_text(size=12),
    # axis.title = element_text(size=12),
    axis.title.x = element_blank(),
    panel.grid.major.x = element_blank(),
    legend.position = 'none',
    strip.text = element_text(size = 12)
  )

most_improved_ebl <- ggplot(most_improved_data_bar_plot_data, aes(trial, ebl_m)) +
  geom_bar(stat='identity', color='black', fill='grey', alpha = 0.5) +
  geom_errorbar(data=most_improved_data_bar_plot_data, aes(ymin=ebl_m-ebl_sd, ymax=ebl_m+ebl_sd), width=0.2) +
  # geom_point(position = position_jitter(width = 0.25)) +
  scale_fill_jama() +
  # facet_wrap(~Group) +
  xlab('Trial Number') +
  ylab('Estimated Blood Loss (mL)') +
  scale_y_continuous(expand = c(0,0), limits = c(0, 800)) +
  theme_bw() +
  theme(
    text = element_text(size = 12),
    axis.text = element_text(size=12),
    # axis.title = element_text(size=12),
    axis.title.x = element_blank(),
    panel.grid.major.x = element_blank(),
    legend.position = 'none',
    strip.text = element_text(size = 12)
  )
```

```{r}
tth_most_improved_t1_vs_t2 <- ggplot(change_in_scores %>% filter(SurveyID %in% most_improved_data$SurveyID), aes(color=Group)) +
  geom_segment(aes(x = SurveyID, xend=SurveyID, y = TTH_1, yend = TTH_2)) +
  geom_point(aes(x=SurveyID, y= TTH_1), color='grey') +
  geom_point(aes(x=SurveyID, y= TTH_2), color='black') +
  guides(color=guide_legend(title='', title.position = 'top')) +
  xlab('Individual ranked by improvement based on TTH change') +
  ylab('TTH (Trial 1 (grey) vs. Trial 2 (black))') +
  scale_color_jama() +
  theme_bw() +
  theme(
    legend.position = c(0.01,0.01),
    legend.justification = c(0,0),
    legend.background = element_rect(fill='transparent'),
    legend.text = element_text(size=12),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )
```

```{r}
ebl_most_improved_t1_vs_t2 <- ggplot(change_in_scores %>% filter(SurveyID %in% most_improved_data$SurveyID), aes(color=Group)) +
  geom_segment(aes(x = SurveyID, xend=SurveyID, y = ebl_1, yend = ebl_2)) +
  geom_point(aes(x=SurveyID, y= ebl_1), color='grey') +
  geom_point(aes(x=SurveyID, y= ebl_2), color='black') +
  guides(color=guide_legend(title='', title.position = 'top')) +
  xlab('Individual ranked by improvement based on TTH change') +
  ylab('TTH (Trial 1 (grey) vs. Trial 2 (black))') +
  scale_color_jama() +
  theme_bw() +
  theme(
    legend.position = c(0.01,0.01),
    legend.justification = c(0,0),
    legend.background = element_rect(fill='transparent'),
    legend.text = element_text(size=12),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )
```

```{r}
line_plot_data_most_improved <- change_in_scores %>%
  filter(SurveyID %in% most_improved_data$SurveyID) %>%
  dplyr::select(-change_in_tth, -change_in_ebl) %>%
  gather(s, v, -SurveyID, -Group) %>%
  mutate(var=stringr::str_extract(pattern='TTH|ebl', string=s)) %>%
  mutate(Trial=paste0('Trial ', stringr::str_extract(pattern='[0-9]+', string=s))) %>%
  reshape2::dcast(SurveyID + Group + Trial ~ var, value.var='v') %>%
  mutate(SurveyID=factor(SurveyID, levels=ordered_survey_id[which(ordered_survey_id %in% most_improved_data$SurveyID)])) %>%
  mutate(x=as.integer(SurveyID))

tth_line_most_improved_t1_vs_t2 <- ggplot(line_plot_data_most_improved, aes(x, TTH, color=Trial)) +
  geom_line(size=1.5) +
  guides(color=guide_legend(title='', title.position = 'top')) +
  xlab('Individual ranked by improvement based on TTH change') +
  ylab('Time to hemostasis (seconds)') +
  scale_color_manual(values=c('grey', 'black')) +
  theme_bw() +
  theme(
    legend.position = c(0.01,0.01),
    legend.justification = c(0,0),
    legend.background = element_rect(fill='transparent'),
    legend.text = element_text(size=12),
    axis.text = element_text(size=12),
    axis.title.x = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )

ebl_line_most_improved_t1_vs_t2 <- ggplot(line_plot_data_most_improved, aes(x, ebl, color=Trial)) +
  geom_line(size=1.5) +
  guides(color=guide_legend(title='', title.position = 'top')) +
  xlab('Individual ranked by improvement based on TTH change') +
  ylab('Estimated blood loss (mL)') +
  scale_color_manual(values=c('grey', 'black')) +
  theme_bw() +
  theme(
    legend.position = 'none',
    # legend.position = c(0.01,0.01),
    # legend.justification = c(0,0),
    # legend.background = element_rect(fill='transparent'),
    # legend.text = element_text(size=12),
    axis.title.x = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.text.x = element_blank(),
    axis.text = element_text(size=12),
    axis.ticks.x = element_blank()
  )
```

```{r}
ggplot(change_in_scores, aes(TTH_1, TTH_2, color=Group)) +
  geom_point() +
  geom_abline(slope=1, linetype=2)
```

<!-- ## Coaching -->

```{r}
coaching_data <- read_tsv(file_to_use) %>% 
  filter(!is.na(SurveyID)) %>%
  mutate(Group=case_when(
    (!is.na(Attyears) & Attyears) >= 1 ~ 'Attending',
    (!is.na(Resyears) & Resyears) >= 1 ~ 'Resident',
    TRUE ~ 'None'
  )) %>%
  # For now, filter out those that are not attendings or residents, but will want to come back to this later
  filter(Group != 'None')

# We should remove the people who did three trials for now, as they were not trained between trial 1 and 2 but trained between trials 2 and 3, so we will need to think about how to compare them to everyone else
coaching_data %<>% filter(!is.na(`Trial 3 Start Time (hhmmss)`))
```

```{r include=FALSE}
coaching_tth_data <- coaching_data %>%
  dplyr::select(SurveyID, Group, tth_columns) %>%
  gather(var, value, -SurveyID, -Group) %>%
  mutate(trial = gsub(' TTH', '', var)) %>%
  mutate(trial=factor(trial, c('Trial 1', 'Trial 2', 'Trial 3')))

tth_coaching_p_values_t1_t2 <- coaching_data %>%
  dplyr::select(SurveyID, Group, tth_columns) %>%
  gather(var, value, -SurveyID, -Group) %>%
  mutate(trial = gsub(' TTH', '', var)) %>%
  filter(trial %in% paste0('Trial ', c(1,2,3))) %>%
  reshape2::dcast(SurveyID + Group ~ trial, value.var='value') %>%
  dplyr::summarise(
    t1_t2_p = t.test(`Trial 1`, `Trial 2`)$p.value,
    t1_t2_conf_min = t.test(`Trial 1`, `Trial 2`)$conf.int[1],
    t1_t2_conf_max = t.test(`Trial 1`, `Trial 2`)$conf.int[2],
    t1_t3_p = t.test(`Trial 1`, `Trial 3`)$p.value,
    t1_t3_conf_min = t.test(`Trial 1`, `Trial 3`)$conf.int[1],
    t1_t3_conf_max = t.test(`Trial 1`, `Trial 3`)$conf.int[2]
  )

coaching_mean_tth <- coaching_tth_data %>%
  group_by(trial, Group) %>%
  dplyr::summarise(m=mean(value, na.rm = T))
```

```{r}
coaching_tth_data_bar <- coaching_tth_data %>%
  group_by(trial) %>%
  dplyr::summarise(m=mean(value, na.rm = T), s=sd(value, na.rm = T)/sqrt(length(value[!is.na(value)])))

coaching_tth_overall_plot <- ggplot(coaching_tth_data_bar, aes(trial, m, fill=trial)) +
  geom_bar(stat = 'identity', color = 'black', alpha=0.5, fill='grey') +
  geom_errorbar(aes(ymin=m-s, ymax=m+s), width = 0.2) +
  annotate(geom = 'text', x = 3, y = 300, label = '*', size = 12) +
  # geom_point(position = position_jitter(width = 0.25)) +
  # stat_summary(fun.y = 'mean', geom = 'line', color='black') +
  # scale_fill_jama() +
  scale_y_continuous(limits = c(0,320), expand = c(0,0)) +
  # facet_wrap(~Group) +
  xlab('Trial Number') +
  ylab('Time to Hemostasis') +
  theme_bw() +
  theme(
    text = element_text(size = 12),
    axis.text = element_text(size=12),
    # axis.title = element_text(size=12),
    axis.title.x = element_blank(),
    panel.grid.major.x = element_blank(),
    legend.position = 'none',
    strip.text = element_text(size = 12)
  )

coaching_tth_overall_plot
```

```{r include=FALSE}
coaching_ebl_data <- coaching_data %>%
  dplyr::select(SurveyID, Group, ebl_columns) %>%
  magrittr::set_colnames(gsub('  ', ' ', colnames(.))) %>%
  gather(var, value, -SurveyID, -Group) %>%
  mutate(trial = gsub(' ebl', '', var)) %>%
  mutate(trial=factor(gsub('^t', 'T', trial), c('Trial 1', 'Trial 2', 'Trial 3')))

ebl_coaching_p_values_t1_t2 <- coaching_data %>%
  dplyr::select(SurveyID, Group, ebl_columns) %>%
  magrittr::set_colnames(gsub('  ', ' ', colnames(.))) %>%
  gather(var, value, -SurveyID, -Group) %>%
  mutate(trial = gsub(' ebl', '', var)) %>%
  mutate(trial=gsub('^t', 'T', trial)) %>%
  filter(trial %in% paste0('Trial ', c(1,2,3))) %>%
  reshape2::dcast(SurveyID + Group ~ trial, value.var='value') %>%
  dplyr::summarise(
    t1_t2_p = t.test(`Trial 1`, `Trial 2`)$p.value,
    t1_t2_conf_min = t.test(`Trial 1`, `Trial 2`)$conf.int[1],
    t1_t2_conf_max = t.test(`Trial 1`, `Trial 2`)$conf.int[2],
    t1_t3_p = t.test(`Trial 1`, `Trial 3`)$p.value,
    t1_t3_conf_min = t.test(`Trial 1`, `Trial 3`)$conf.int[1],
    t1_t3_conf_max = t.test(`Trial 1`, `Trial 3`)$conf.int[2]
  )

# ggplot(coaching_ebl_data, aes(trial, value)) +
#   geom_boxplot(outlier.shape=NA) +
#   stat_compare_means(label = "p.signif", method = "t.test",
#                      ref.group = "Trial 1")

coaching_mean_ebl <- coaching_ebl_data %>%
  group_by(trial, Group) %>%
  dplyr::summarise(m=mean(value, na.rm = T))
```

```{r}
coaching_ebl_data_bar <- coaching_ebl_data %>%
  group_by(trial) %>%
  dplyr::summarise(m=mean(value, na.rm = T), s=sd(value, na.rm = T)/sqrt(length(value[!is.na(value)])))

coaching_ebl_overall_plot <- ggplot(coaching_ebl_data_bar, aes(trial, m, fill=trial)) +
  geom_bar(stat = 'identity', color = 'black', alpha=0.5, fill='grey') +
  geom_errorbar(aes(ymin=m-s, ymax=m+s), width = 0.2) +
  annotate(geom = 'text', x = 3, y = 420, label = '*', size = 12) +
  # geom_point(position = position_jitter(width = 0.25)) +
  # stat_summary(fun.y = 'mean', geom = 'line', color='black') +
  # scale_fill_jama() +
  scale_y_continuous(limits = c(0,480), expand = c(0,0)) +
  # facet_wrap(~Group) +
  xlab('Trial Number') +
  ylab('Estimated blood loss (mL)') +
  theme_bw() +
  theme(
    text = element_text(size = 12),
    axis.text = element_text(size=12),
    # axis.title = element_text(size=12),
    axis.title.x = element_blank(),
    panel.grid.major.x = element_blank(),
    legend.position = 'none',
    strip.text = element_text(size = 12)
  )
```

```{r}
success_rate_coaching <- coaching_data %>% 
  dplyr::select(SurveyID, `Trial 1` = `Trial 1 Success`, `Trial 2`=`Trial 2 Success`, `Trial 3`=`Trial 3 Success`) %>%
  gather(trial, s, -SurveyID) %>%
  filter(!is.na(s)) %>%
  group_by(trial) %>%
  dplyr::summarise( 
    rate=length(which(s==1))/n()
  )

coaching_success_rate <- ggplot(success_rate_coaching, aes(trial, rate)) +
  geom_bar(stat = 'identity', color='black', fill='grey', alpha = 0.5) +
  # scale_fill_jama() +
  # facet_wrap(~Group) +
  xlab('Trial Number') +
  ylab('Trial success rate') +
  scale_y_continuous(limits = c(0, 1.05), expand = c(0,0)) +
  theme_bw() +
  theme(
    text = element_text(size = 12),
    axis.text = element_text(size=12),
    # axis.title = element_text(size=12),
    axis.title.x = element_blank(),
    panel.grid.major.x = element_blank(),
    legend.position = 'none',
    strip.text = element_text(size = 12)
  )
```


# Final figures

```{r}
figure1_top <- ggpubr::ggarrange(
  overall_success_rate, tth_overall_plot, overall_ebl, 
  nrow=1, labels=c("a", "b", "c"), widths = c(1,1,1)
)

figure1_bottom <- ggpubr::ggarrange(
  tth_change_overall, ebl_change_overall, widths = c(1,1), labels = c("d", "e")
  # common.legend = T, legend='right' 
)

figure1 <- annotate_figure(ggpubr::ggarrange(
  figure1_top, figure1_bottom, heights = c(1,1.5), nrow = 2
), bottom = text_grob('Individual ranked by improvement in TTH'))

ggsave(figure1, width = 10, height = 8, units = 'in', filename = paste0(plot_dir, '/overall_performance.pdf'), device = 'pdf')
```

```{r}
figure_legend_data <- list(
  fig1b = list(
    trial_1_mean=tth_data_m_median %>% filter(trial=='Trial 1') %$% m[1] %>% round(., 1),
    trial_2_mean=tth_data_m_median %>% filter(trial=='Trial 2') %$% m[1] %>% round(., 1),
    p_value=formatC(tth_data_t_test$p.value, format = "e", digits = 2),
    confidence=round(tth_data_t_test$conf.int, 1)
  ),
  fig1c = list(
    trial_1_mean=overall_ebl_data %>% filter(trial=='Trial 1') %$% m[1] %>% round(., 1),
    trial_2_mean=overall_ebl_data %>% filter(trial=='Trial 2') %$% m[1] %>% round(., 1),
    p_value=formatC(ebl_test_test_values$p.value, format = "e", digits = 2),
    confidence=round(ebl_test_test_values$conf.int, 1)
  ),
  suppfig1b = list(
    attending = list(
      trial_1_mean=tth_data_t_test_by_group %>% filter(Group=='Attending') %$% m_t1[1] %>% round(., 1),
      trial_2_mean=tth_data_t_test_by_group %>% filter(Group=='Attending') %$% m_t2[1] %>% round(., 1),
      p_value=formatC((tth_data_t_test_by_group %>% filter(Group=='Attending') %$% p[1]), format = "e", digits = 2),
      confidence=round((tth_data_t_test_by_group %>% filter(Group=='Attending') %$% c(ci_low[1], ci_high[1])), 1)
    ),
    resident = list(
      trial_1_mean=tth_data_t_test_by_group %>% filter(Group=='Resident') %$% m_t1[1] %>% round(., 1),
      trial_2_mean=tth_data_t_test_by_group %>% filter(Group=='Resident') %$% m_t2[1] %>% round(., 1),
      p_value=formatC((tth_data_t_test_by_group %>% filter(Group=='Resident') %$% p[1]), format = "e", digits = 2),
      confidence=round((tth_data_t_test_by_group %>% filter(Group=='Resident') %$% c(ci_low[1], ci_high[1])), 1)
    )
  ),
  suppfig1c = list(
    attending = list(
      trial_1_mean=by_group_ebl_data %>% filter(Group=='Attending', trial=='Trial 1') %$% m[1] %>% round(., 1),
      trial_2_mean=by_group_ebl_data %>% filter(Group=='Attending', trial=='Trial 2') %$% m[1] %>% round(., 1),
      p_value=formatC((ebl_test_test_values_by_group %>% filter(Group=='Attending') %$% p[1]), format = "e", digits = 2),
      confidence=round((ebl_test_test_values_by_group %>% filter(Group=='Attending') %$% c(ci_low[1], ci_high[1])), 1)
    ),
    resident = list(
      trial_1_mean=by_group_ebl_data %>% filter(Group=='Resident', trial=='Trial 1') %$% m[1] %>% round(., 1),
      trial_2_mean=by_group_ebl_data %>% filter(Group=='Resident', trial=='Trial 2') %$% m[1] %>% round(., 1),
      p_value=formatC((ebl_test_test_values_by_group %>% filter(Group=='Resident') %$% p[1]), format = "e", digits = 2),
      confidence=round((ebl_test_test_values_by_group %>% filter(Group=='Resident') %$% c(ci_low[1], ci_high[1])), 1)
    )
  ),
  fig2b = list(
    trial_1_mean=coaching_mean_tth %>% filter(trial == 'Trial 1') %$% m[1] %>% round(., 1),
    trial_2_mean=coaching_mean_tth %>% filter(trial == 'Trial 2') %$% m[1] %>% round(., 1),
    trial_3_mean=coaching_mean_tth %>% filter(trial == 'Trial 3') %$% m[1] %>% round(., 1),
    p_value_t1_t2=tth_coaching_p_values_t1_t2[1,"t1_t2_p"],
    p_value_t1_t3=tth_coaching_p_values_t1_t2[1,"t1_t3_p"]
  ),
  fig2c = list(
    trial_1_mean=coaching_mean_ebl %>% filter(trial == 'Trial 1') %$% m[1] %>% round(., 1),
    trial_2_mean=coaching_mean_ebl %>% filter(trial == 'Trial 2') %$% m[1] %>% round(., 1),
    trial_3_mean=coaching_mean_ebl %>% filter(trial == 'Trial 3') %$% m[1] %>% round(., 1),
    p_value_t1_t2=ebl_coaching_p_values_t1_t2[1,"t1_t2_p"],
    p_value_t1_t3=ebl_coaching_p_values_t1_t2[1,"t1_t3_p"]
  )
)
```

## Figure 1. Overall performance changes trial 1 vs. trial 2

(a) Success rate of participants in trial 1 and 2. 
(b) Mean time to hemostasis in trial 1 (`r figure_legend_data$fig1b$trial_1_mean` sec) vs. trial 2 (`r figure_legend_data$fig1b$trial_2_mean` sec). p = `r figure_legend_data$fig1b$p_value`, 95% CI: `r figure_legend_data$fig1b$confidence[1]`-`r figure_legend_data$fig1b$confidence[2]` sec. 
(c) Mean estimated blood loss (mL) in trial 1 (`r figure_legend_data$fig1c$trial_1_mean` mL) vs. trial 2 (`r figure_legend_data$fig1c$trial_2_mean` mL). p = `r figure_legend_data$fig1c$p_value`, 95% CI: `r figure_legend_data$fig1c$confidence[1]`-`r figure_legend_data$fig1c$confidence[2]` mL. 
(d) Number of seconds saved in time to hemostasis in trial 2 vs. trial 1. Positive values indicate a decrease in time to hemostatis in trial 2 vs. trial 1; negative values indicate an increase. Each point is an individual, with individuals ordered increasingly based on change in time to hemostatis. 
(e) Same as (d) but comparing estimated blood loss change between trial 1 and trial 2. Individuals are ordered as in (d).

```{r include=TRUE, fig.height=8}
figure1
```

```{r}
supp_figure1 <- ggpubr::ggarrange(
  by_group_success_rate, tth_split_by_training, by_group_ebl, 
  nrow=1, labels=c("a", "b", "c"), widths = c(2,2,2), common.legend = T, legend = 'bottom'
)

ggsave(supp_figure1, width = 10, height = 4, units = 'in', filename = paste0(plot_dir, '/overall_performance_by_group.pdf'), device = 'pdf')
# fig1_final <- annotate_figure(
#   figure1,
#   left = text_grob("Time to hemostasis", color = "black", rot = 90, size = 12)
# )

# fig1_final
```

## Supplemental Figure 1. Overall performance split by attending and resident

(a) Success rate of participants in trial 1 and 2, attending and residents split. 
(b) For attendings, mean time to hemostasis in trial 1 (`r figure_legend_data$suppfig1b$attending$trial_1_mean` sec) vs. trial 2 (`r figure_legend_data$suppfig1b$attending$trial_2_mean` sec). p = `r figure_legend_data$suppfig1b$attending$p_value`, 95% CI: `r figure_legend_data$suppfig1b$attending$confidence[1]`-`r figure_legend_data$suppfig1b$attending$confidence[2]` sec. For residents, mean time to hemostasis in trial 1 (`r figure_legend_data$suppfig1b$resident$trial_1_mean` sec) vs. trial 2 (`r figure_legend_data$suppfig1b$resident$trial_2_mean` sec). p = `r figure_legend_data$suppfig1b$resident$p_value`, 95% CI: `r figure_legend_data$suppfig1b$resident$confidence[1]`-`r figure_legend_data$suppfig1b$resident$confidence[2]` sec. 
(c) For attendings, mean estimated blood loss in trial 1 (`r figure_legend_data$suppfig1c$attending$trial_1_mean` mL) vs. trial 2 (`r figure_legend_data$suppfig1c$attending$trial_2_mean` mL). p = `r figure_legend_data$suppfig1c$attending$p_value`, 95% CI: `r figure_legend_data$suppfig1c$attending$confidence[1]`-`r figure_legend_data$suppfig1c$attending$confidence[2]` mL. For residents, mean estimated blood loss in trial 1 (`r figure_legend_data$suppfig1c$resident$trial_1_mean` mL) vs. trial 2 (`r figure_legend_data$suppfig1c$resident$trial_2_mean` mL). p = `r figure_legend_data$suppfig1c$resident$p_value`, 95% CI: `r figure_legend_data$suppfig1c$resident$confidence[1]`-`r figure_legend_data$suppfig1c$resident$confidence[2]` mL.

```{r include=TRUE}
supp_figure1
```

## Figure 2. Effect of coaching versus practice

(a) Success rate in 12 participants across trials 1, 2, and 3.
(b) Time to hemostatsis in 12 participants across trial 1, 2, and 3. No significant improvement in trial 1 vs. trial 2 (p=`r figure_legend_data$fig2b$p_value_t1_t2`). Significant improvement in trial 1 vs. trial 3 (p=`r figure_legend_data$fig2b$p_value_t1_t3`).
(c) Estimated blood loss in 12 participants across trial 1, 2, and 3. No significant improvement in trial 1 vs. trial 2 (p=`r figure_legend_data$fig2c$p_value_t1_t2`). Significant improvement in trial 1 vs. trial 3 (p=`r figure_legend_data$fig2c$p_value_t1_t3`).

```{r}
figure2 <- ggpubr::ggarrange(
  coaching_success_rate, coaching_tth_overall_plot, coaching_ebl_overall_plot, 
  nrow=1, labels=c("a", "b", "c"), widths = c(1, 1,1)
)

ggsave(figure2, width = 10, height = 5, units = 'in', filename = paste0(plot_dir, '/coaching_figure.pdf'), device = 'pdf')
```

```{r, include=T}
figure2
```

## Figure 3. Training successes

(a) Change in TTH between trial 1 and trial 2 in participants considered training successes (failed trial 1, passed trial 2). By definition, failure in trial 1 means a TTH of 300 seconds.
(b) Change in EBL between trial 1 and trial 2 in training successes.
(c) TTH between trial 1 and trial 2 in training successes. Participants are organized by improvement in TTH.
(d) EBL between trial 1 and trial 2 in training successes. Participants are ordered on the x-axis as in (c)

```{r}
figure3_top <- ggpubr::ggarrange(
  most_improved_tth, most_improved_ebl, 
  nrow=1, labels=c("a", "b"), widths = c(1,1)
)

figure3_bottom <- ggpubr::ggarrange(
  tth_line_most_improved_t1_vs_t2, ebl_line_most_improved_t1_vs_t2, widths = c(1,1), labels = c("c", "d")
  # common.legend = T, legend='right' 
)

figure3 <- annotate_figure(ggpubr::ggarrange(
  figure3_top, figure3_bottom, heights = c(1,1.5), nrow = 2
), bottom = text_grob('Individual ranked by improvement in TTH'))

ggsave(figure3, width = 10, height = 8, units = 'in', filename = paste0(plot_dir, '/trial_successes.pdf'), device = 'pdf')
```

```{r include=TRUE, fig.height=8}
figure3
```



